---
status: done
priority: p1
issue_id: "001"
tags: [security, security-sentinel, path-traversal, cvss-8.6]
dependencies: []
---

## Problem Statement

**CRITICAL SECURITY VULNERABILITY**: File paths constructed using unvalidated `year_num` and `month` values from Google Drive filenames allow potential path traversal attacks. An attacker could write to arbitrary file locations, overwrite system files, or inject malicious content.

## Findings

**Location:** `src/modules/ingest.py:217`

**Evidence:**
```python
csv_path = STAGING_DATA_DIR / "import_export" / f"{year_num}_{month}_{tab}.csv"
```

**Impact:** No validation that `year_num` and `month` values are within expected ranges. If filenames contain malicious path segments like `../../../etc/passwd`, they will be concatenated and used directly.

**CVSS Score:** 8.6 (HIGH)

**Attack Vector:**
- Attacker can manipulate Google Sheet filenames
- Concatenated with directory paths without sanitization
- Resulting path used for file write operations
- Can write outside staging directory

**Root Cause:** Missing input validation and path resolution checks before constructing file paths.

## Proposed Solutions

### Option 1: Add Comprehensive Path Validation (Recommended)

**Description:** Add validation for year/month ranges and path resolution checks before using constructed paths.

**Pros:**
- Prevents all path traversal attacks
- Validates data integrity at source
- Clear error messages for invalid inputs
- Minimal performance impact

**Cons:**
- Adds 5-10 lines of validation code
- Requires updating year/month range logic if they change
- Still allows legitimate edge cases to pass

**Effort:** Small (1-2 hours)

**Risk:** Low (standard validation pattern)

**Implementation:**
```python
# Before path construction in _process_import_export_receipts()
def _validate_year_month(year_num: int, month: int) -> None:
    """Validate year and month ranges."""
    if not (2020 <= year_num <= 2030):
        raise ValueError(f"Invalid year: {year_num} (must be 2020-2030)")
    if not (1 <= month <= 12):
        raise ValueError(f"Invalid month: {month} (must be 1-12)")

# Then in the path construction:
_validate_year_month(year_num, month)
csv_path = (STAGING_DATA_DIR / "import_export" / f"{year_num}_{month}_{tab}.csv").resolve()
if not str(csv_path).startswith(str(STAGING_DATA_DIR.resolve())):
    raise ValueError(f"Invalid path: {csv_path} escapes staging directory")
```

### Option 2: Use pathlib Path.join with Strict Mode

**Description:** Use Path.join() with strict mode to prevent parent directory traversal.

**Pros:**
- Built-in protection against path traversal
- Cleaner code (uses stdlib)
- Automatically resolves `..` and `.` segments
- Maintains path semantics

**Cons:**
- May reject some legitimate use cases (e.g., symbolic links to staging)
- Less granular error messages
- Need to test edge cases thoroughly

**Effort:** Small (1 hour)

**Risk:** Medium (may break existing workflows)

**Implementation:**
```python
csv_path = (STAGING_DATA_DIR / "import_export").joinpath(f"{year_num}_{month}_{tab}.csv")
if not csv_path.is_relative_to(STAGING_DATA_DIR / "import_export"):
    raise ValueError(f"Invalid path: {csv_path} escapes staging directory")
```

### Option 3: Implement Sanitized Filename Pattern

**Description:** Create a helper function that sanitizes filenames by removing path characters and validating against allowlist.

**Pros:**
- Centralizes filename handling logic
- Can be reused across all file operations
- Explicit about what characters are allowed
- Easier to test independently

**Cons:**
- Most invasive change (requires updating all file path construction)
- May conflict with Vietnamese tab names (spaces, accents)
- Higher maintenance burden

**Effort:** Medium (2-3 hours)

**Risk:** Low (new dependency on helper function)

**Implementation:**
```python
import re

def sanitize_filename(name: str) -> str:
    """Remove dangerous characters from filename."""
    # Remove path traversal characters
    sanitized = re.sub(r'[./\\]', '', name)
    # Allow only: alphanumeric, spaces, hyphens, underscores, Vietnamese chars
    sanitized = re.sub(r'[^\w\s\-áàảãăâấêìôọơúưỳíýđ]', '', sanitized, flags=re.UNICODE)
    # Limit length
    return sanitized[:255]

# Use everywhere:
safe_tab_name = sanitize_filename(tab)
csv_path = STAGING_DATA_DIR / "import_export" / f"{year_num}_{month}_{safe_tab_name}.csv"
```

## Recommended Action

Implement **Option 1** (Add Comprehensive Path Validation) as it provides the best balance of security, maintainability, and backwards compatibility.

1. Add `_validate_year_month()` function to ingest.py
2. Call it before constructing csv_path in `_process_import_export_receipts()`
3. Add `.resolve()` and prefix check to validate final path
4. Add tests for malicious year/month values (e.g., `../../../`, `0`, `13`, `9999`)
5. Document validation rules in AGENTS.md

## Acceptance Criteria

- [ ] Year values outside 2020-2030 raise ValueError
- [ ] Month values outside 1-12 raise ValueError
- [ ] Path traversal attempts (e.g., `../../etc/passwd`) raise ValueError
- [ ] Valid paths (e.g., `2025_1_Chi tiết nhập.csv`) work correctly
- [ ] Error messages clearly state what validation failed
- [ ] Tests cover malicious input scenarios
- [ ] No regression for legitimate filenames

## Work Log

### 2026-01-23 - Initial Review
- Created todo file from security-sentinel findings
- Analyzed path construction in ingest.py:217
- Identified missing validation for year_num and month values
- Proposed 3 solution options with tradeoffs
- Selected Option 1 as recommended approach

### 2026-01-24 - Approved for Work
**By:** Claude Triage System
**Actions:**
- Issue approved during triage session
- Status changed from pending → ready
- Ready to be picked up and worked on

**Learnings:**
- Critical security vulnerability requiring immediate attention
- Option 1 (Comprehensive Path Validation) selected as recommended approach
- Small effort (1-2 hours) with high security impact

---

## Technical Details

**Affected Files:**
- `src/modules/ingest.py:217` (csv_path construction)
- `src/modules/ingest.py:147-230` (_process_import_export_receipts function)

**Root Cause:**
Missing input validation and path sanitization

**Related Code:**
- Google Drive filename parsing logic
- Staging directory structure
- File write operations in google_api.py

**Database Changes:** None

**Migration Required:** No

## Resources

- **Security Advisory:** CWE-22 (Improper Limitation of a Pathname to a Restricted Directory)
- **OWASP Path Traversal:** https://owasp.org/www-community/attacks/Path_Traversal
- **Python Path Best Practices:** https://docs.python.org/3/library/pathlib.html
- **Related PR:** Commit 487d1c7 on branch refactor-switch-import-export-to-cleaned-tabs
